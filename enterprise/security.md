# Reviewable Enterprise security overview

This page offers an overview of Reviewable's security-related features.  Note that while there are many ways to configure Reviewable we'll only discuss the most secure (and recommended!) configuration here.

Everything on this page applies to both self-hosted and managed Enterprise instances.  A managed instance is just a self-hosted instance that we run for you (outside your VPN), configured as follows:
- Reviewable Servers and image storage run on GCP.
- Completion conditions execute on AWS Lambda.
- Firebase is set up with security rules and encryption.

## Architecture

Reviewable is somewhat unusual for on-premises software in that it needs to be connected to cloud services to function.  This architecture diagram summarizes the various pieces and how they communicate:

![Architectural diagram](https://github.com/Reviewable/Reviewable/blob/master/enterprise/images/architectural_diagram.svg)

All communication is over channels secured with TLS, and obviously certificate verification is turned on.

## Authentication

Reviewable relies entirely on GitHub Enterprise (GHE) for authentication, via the usual OAuth three-party redirect dance.  If you've configured your GHE instance to use SSO via SAML then Reviewable will use that too.  There are no separate local user accounts to maintain within Reviewable.

When a user signs in, Reviewable obtains and stores an OAuth token that lets it impersonate the user within the scopes that were granted.  Reviewable needs some very broad scopes to function (including `repo`) so to a first approximation you can assume that it inherits each user's full power.  We're not aware of any way to distinguish Reviewable's impersonated actions from the user's in GHE or otherwise independently audit Reviewable's use of the tokens.

Please see [here](auth.md#reviewable-authentication-flow) for full details on the authentication flow.

## Authorization

Authorizations in Reviewable are inferred from the permissions granted to users in GHE, i.e. repository read/write/admin and organization owner.  There are no separate roles or authorizations maintained within Reviewable (with one small exception, detailed below).  Permission checks against GHE are cached and revalidated every 15 to 120 minutes depending on their sensitivity.

Please see [here](auth.md#reviewable-authorization-flow) for full details on the authorization flow.

Reviewable has an additional role of "license administrator" that can check the license details and manage some license-level settings.  All GHE installation owners (i.e., instance admins) are considered to be license administrators, and you can also explicitly designate one additional user as such (encoded in the license key).

## Firebase

Reviewable stores all its data in Firebase, a database-as-a-service offered by Google Cloud Services.  You will create a new instance as part of Reviewable's setup process and retain exclusive control of it, though Reviewable will otherwise manage it for you.  This database is Reviewable's sole means of persisting data, so everything ends up in there:  review comments, filenames, various `git` SHAs, commit messages, issue titles, cached user details, etc.  However, repository contents are _never_ stored in the database.

The database is accessible over the Internet and, to the best of our knowledge, cannot be isolated inside a VPN even if you use GCS for your other services.  It is secured via two independent methods.

First, Firebase enforces a set of security rules that are defined as part of our development process and uploaded by the Reviewable server.  These rules specify who can read or write specific locations in the schema, based on a user's authentication and the GHE permissions mentioned above.  Firebase authentication tokens are generated by Reviewable's server after a user has successfully authenticated via GHE, based on a secret shared between your Firebase instance and your Reviewable instance.  A Firebase token issued by Reviewable is good for 90 days, but keep in mind that nearly all access is gated by the GHE permissions that are rechecked every half hour.

Second, Reviewable encrypts much of the database with keys that you generate and that never leave your network, encrypting and decrypting data on its servers and in the clients.  GHE OAuth tokens are encrypted with RSA-OAEP and the keys never leave the server.  (The use of public key encryption is an oddity carried over from an earlier design for backwards compatibility.)  These keys can be easily rotated.  Other data is encrypted with AES-SIV (to preserve indexability); basically anything that's human-readable is encrypted, including review comments, filenames, repository names, etc.  Numbers, booleans, SHAs, flags and such are typically not encrypted to reduce the workload, especially on the clients where all the crypto runs in the browser.  (We can share a schema file that specifies exactly what is and isn't encrypted under NDA.)  The key for this encryption is distributed by the servers to the clients as part of the initial page load, unless you're running Reviewable in private mode, in which case it's only provided on successful sign-in.  This key can be rotated but it's a pretty painful process that requires taking Reviewable offline for hours, or possibly even a day or two.

## Optional cloud services

Reviewable can benefit from being connected to some other cloud services to enable optional features.  If you choose to do so you will retain exclusive control of the services, though Reviewable will otherwise manage their use for you.  If not configured, the features will simply be unavailable.

1.  To allow users to attach images to their review comments, you'll need to give Reviewable someplace to store them.  This could be a volume mounted into your Docker container, but it's often more convenient to use an AWS S3 or GCS Storage bucket.

2.  To support custom review completion conditions you'll need to connect Reviewable to AWS Lambda.  These conditions are short snippets of JavaScript code that can be configured by repository admins and that Reviewable will run in Lambda whenever necessary (one function per repository to provide isolation).  The condition will be provided with basic metadata about the review (filenames included, but not file contents or review comments) and return its determination.  (Note that you can also configure conditions to be executed locally on Reviewable's servers, but this is not recommended in production since the sandboxing there is best-effort and most likely possible to break out of.)

